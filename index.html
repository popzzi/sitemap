<!doctype html>
<html>
<head>
  <!-- âŒ base ì œê±° (GitHub Pagesì—ì„œëŠ” ë¶ˆí•„ìš”) -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‚¬ì´íŠ¸ë§µ</title>

  <!-- ===== CSS (ì›ë³¸ ê·¸ëŒ€ë¡œ) ===== -->
  <style>
    :root{
      --text:#e8eefc;
      --muted:#a7b4d6;
      --line:rgba(255,255,255,.08);
      --accent:#7aa2ff;
      --accent2:#52d6a8;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      background: linear-gradient(180deg, #070b14, #0b1220 40%, #07101f);
      color:var(--text);
    }
    .app{display:flex;height:100vh;width:100%;overflow:hidden;}
    aside{
      width:320px;min-width:280px;
      background: rgba(15,26,48,.85);
      border-right:1px solid var(--line);
      padding:18px;overflow:auto;
      backdrop-filter: blur(10px);
    }
    main{flex:1;padding:18px;overflow:auto;}
    .brand{display:flex;align-items:center;gap:4px;padding:5px;}
    .logo{
      width: 37px;
      height: 37px;
      background-image: url(https://img.icons8.com/?size=100&id=SQ7k596FkHLa&format=png&color=000000);
      background-size: cover;
    }
    .brand h1{font-size:16px;margin:0}
    .brand p{margin:2px 0 0;font-size:12px;color:var(--muted)}
    .search{
      margin:8px 0 14px;
      position:sticky;top:0;
      background: rgba(15,26,48,.92);
      padding-bottom:10px;z-index:5;
    }
    .search input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    .search input::placeholder{color:rgba(231,237,255,.45)}
    .section-title{
      font-size:12px;color:var(--muted);
      margin:14px 6px 8px;
      text-transform: uppercase;
      letter-spacing:.06em;
    }
    .cat-list{display:grid;grid-template-columns: repeat(2, 1fr);gap:6px;}
    .cat-btn{
      display:flex;align-items:center;justify-content:space-between;
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      transition:.15s ease;
      text-align:left;
    }
    .cat-btn:hover{transform: translateY(-1px);background: rgba(255,255,255,.06);}
    .cat-btn.active{outline:2px solid rgba(122,162,255,.45);background: rgba(122,162,255,.10);}
    .pill{
      font-size:12px;color: var(--muted);
      border:1px solid var(--line);
      padding:2px 8px;border-radius:999px;
      background: rgba(0,0,0,.15);
    }
    .topbar{
      display:flex;gap:10px;flex-wrap:wrap;
      align-items:center;justify-content:space-between;
      margin-bottom:12px;
    }
    .topbar .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .chip{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{background: rgba(82,214,168,.12);outline:2px solid rgba(82,214,168,.35);}
    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(220px, 1fr));
      gap:12px;
    }
    @media (max-width:1100px){ .grid{grid-template-columns: repeat(2, minmax(220px, 1fr));} }
    @media (max-width:780px){
      aside{display:none;}
      .grid{grid-template-columns: 1fr;}
      .card{max-width: 350px;}
    }
    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(17,31,58,.65);
      box-shadow: var(--shadow);
      padding:14px;
      display:flex;flex-direction:column;gap:10px;
      min-height:110px;
      position:relative;
    }
    .card:hover{background: rgba(17,31,58,.78);}
    .row{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .title{display:flex;align-items:center;gap:10px;font-weight:700;font-size:14px;line-height:1.2;}
    .icon{
      width:35px;height:35px;border-radius:10px;
      display:grid;place-items:center;
      background: rgba(122,162,255,.12);
      border:1px solid rgba(122,162,255,.22);
      flex:0 0 auto;
    }
    .icon img{width:25px;height:25px;object-fit:contain;}
    .desc{font-size:12px;color:rgba(231,237,255,.75);line-height:1.45;min-height:34px;}
    .meta{display:flex;gap:6px;flex-wrap:wrap;align-items:center;}
    .tag{
      font-size:11px;
      padding:2px 8px;border-radius:999px;
      border:1px solid var(--line);
      color: var(--muted);
      background: rgba(0,0,0,.12);
    }
    .priority{
      border-color: rgba(122,162,255,.35);
      color: rgba(122,162,255,.95);
      background: rgba(122,162,255,.08);
    }
    .actions{display:flex;gap:8px;align-items:center;}
    .btn{
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
      color: var(--text);
      padding:8px 10px;border-radius:12px;
      cursor:pointer;font-size:12px;
      flex:0 0 auto;
      min-width:64px;
      text-align:center;
      white-space:nowrap;
    }
    .btn:hover{background: rgba(255,255,255,.06);}
    .btn.danger{
      border-color: rgba(255,255,255,.14);
      background: rgba(255, 99, 99, .10);
    }
    .btn.danger:hover{
      background: rgba(255, 99, 99, .16);
    }
    .star{
      width:34px;height:34px;border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
      display:grid;place-items:center;
      cursor:pointer;
      user-select:none;
    }
    .star.on{
      background: rgba(255, 214, 102, .14);
      border-color: rgba(255, 214, 102, .35);
    }
    .muted{color:var(--muted);font-size:12px;}
    .empty{
      border:1px dashed rgba(255,255,255,.15);
      border-radius: var(--radius);
      padding:18px;
      background: rgba(255,255,255,.03);
    }
    .loading{
      padding:18px;
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }
    a{color:inherit;text-decoration:none;}
    .url-text{
      flex:1 1 auto;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
  </style>
</head>

<body>
<div class="app">
  <aside>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>ì‚¬ì´íŠ¸ë§µ</h1>
          <p class="muted">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™ ë§í¬ í—ˆë¸Œ</p>
        </div>
      </div>

      <div class="search">
        <input id="q" placeholder="ê²€ìƒ‰: ì„œë¹„ìŠ¤ëª…, ì„¤ëª…, íƒœê·¸â€¦" />
      </div>

      <div class="section-title">ì¹´í…Œê³ ë¦¬</div>
      <div id="cats" class="cat-list"></div>

      <div class="section-title">í•„í„°</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; padding:0 2px 10px;">
        <div id="chipAll" class="chip active">ì „ì²´</div>
        <div id="chipFav" class="chip">ì¦ê²¨ì°¾ê¸°</div>
        <div id="chipRecent" class="chip">ìµœê·¼</div>
      </div>

      <div class="muted" style="padding: 6px 6px 14px; line-height:1.5;">
        â€¢ ë§í¬ ì¶”ê°€/ìˆ˜ì •ì€ ê´€ë¦¬ì ê³„ì •ì˜ êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ Links ì‹œíŠ¸ì—ì„œ ì¼ê´„ ê´€ë¦¬ë©ë‹ˆë‹¤.<br/>
        â€¢ ì¦ê²¨ì°¾ê¸°/ìµœê·¼ì€ ê°œì¸ë³„ë¡œ ì €ì¥ë¼ìš”.<br/><br/>
        @ 2025 Hzzin. all rights reserved.
      </div>
    </aside>

    <main>
      <div class="topbar">
        <div class="left">
          <div id="current" class="muted">ë¡œë”© ì¤‘â€¦</div>
          <div id="count" class="pill">0</div>
        </div>
        <div class="actions">
          <button class="btn" id="refresh" type="button">ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>

      <div id="content" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
    </main>
</div>

<script>
/* ===== ì„¤ì • ===== */
const API = "https://script.google.com/macros/s/AKfycbxvID6a8BAAeqj0HJ1bw1D87xZCYDQqOVXStubkQLCfz-l3i7ok6YrGPIL-cutJLHo05A/exec";

/* ===== state ===== */
var DATA = { categories: [], items: [] };
var USER = JSON.parse(localStorage.getItem('USER') || '{"favorites":[],"recents":[]}');
var selectedCategory = 'ALL';
var mode = 'ALL';
var query = '';

/* ===== init ===== */
document.addEventListener('DOMContentLoaded', function () {

  // ===== init =====
  document.getElementById('q').addEventListener('input', function (e) {
    query = (e.target.value || '').trim();
    render();
  });

  document.getElementById('refresh').addEventListener('click', function () {
    boot(false);
  });

  var chipAll = document.getElementById('chipAll');
  var chipFav = document.getElementById('chipFav');
  var chipRecent = document.getElementById('chipRecent');

  chipAll.onclick = function(){ mode='ALL'; setChip(); render(); };
  chipFav.onclick = function(){ mode='FAV'; setChip(); render(); };
  chipRecent.onclick = function(){ mode='RECENT'; setChip(); render(); };

  function setChip(){
    [chipAll, chipFav, chipRecent].forEach(function(x){ x.classList.remove('active'); });
    if(mode==='ALL') chipAll.classList.add('active');
    if(mode==='FAV') chipFav.classList.add('active');
    if(mode==='RECENT') chipRecent.classList.add('active');
  }
  // ì´ˆê¸° ë¡œë“œ
  boot(false);

});

/* ===== fetch ê¸°ë°˜ boot ===== */
async function boot(){
  const content = document.getElementById('content');
  content.className='loading';
  content.textContent='ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';

  try{
    const res = await fetch(API+'?action=links');
    DATA = await res.json();
    buildCategories();
    render();
  }catch(e){
    content.className='empty';
    content.textContent= e.message || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨';
  }
}
async function saveUserState(){
  await fetch(API + '?action=setUserState', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(USER)
  });
}

/* ===== USER (localStorage) ===== */
function persistUser(){
  localStorage.setItem('USER', JSON.stringify(USER));

  // GAS í™˜ê²½ì—ì„œë§Œ ì„œë²„ ì €ì¥
  if (window.google && google.script && google.script.run) {
    google.script.run.setUserState(USER);
  }
}


/* ===== ë‚˜ë¨¸ì§€ ë¡œì§ì€ ê¸°ì¡´ render / cardHtml ê·¸ëŒ€ë¡œ ì‚¬ìš© ===== */
function buildCategories(){
      var catsEl = document.getElementById('cats');
      catsEl.innerHTML = '';

      catsEl.appendChild(catButton('ALL', 'ì „ì²´', (DATA.items || []).length));

      (DATA.categories || []).forEach(function(cat){
        var count = (DATA.items || []).filter(function(x){ return x.category === cat; }).length;
        catsEl.appendChild(catButton(cat, cat, count));
      });

      selectedCategory = 'ALL';
      setActiveCat();
    }

    function catButton(key, label, count){
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'cat-btn';
      btn.dataset.key = key;
      btn.innerHTML = '<span>' + escapeHtml(label) + '</span><span class="pill">' + count + '</span>';
      btn.onclick = function(){
        selectedCategory = key;
        setActiveCat();
        render();
      };
      return btn;
    }

    function setActiveCat(){
      document.querySelectorAll('.cat-btn').forEach(function(b){ b.classList.remove('active'); });
      var t = document.querySelector('.cat-btn[data-key="' + cssEscape(selectedCategory) + '"]');
      if(t) t.classList.add('active');
    }

    function render(){
      var list = filteredItems();
      var title = modeTitle() + (selectedCategory === 'ALL' ? '' : ' Â· ' + selectedCategory);
      document.getElementById('current').textContent = title;
      document.getElementById('count').textContent = String(list.length);

      var content = document.getElementById('content');

      if(list.length === 0){
        content.className = 'empty';
        content.innerHTML =
          '<div style="font-weight:700; margin-bottom:6px;">í‘œì‹œí•  í•­ëª©ì´ ì—†ì–´ìš”</div>' +
          '<div class="muted">ê²€ìƒ‰ì–´/ì¹´í…Œê³ ë¦¬/í•„í„°ë¥¼ ë°”ê¿”ë³´ì„¸ìš”.</div>';
        return;
      }

      var cards = list.map(function(item){ return cardHtml(item); }).join('');
      content.className = '';
      content.innerHTML = '<div class="grid">' + cards + '</div>';

      // ë§í¬ ì—´ê¸°
      content.querySelectorAll('[data-action="open"]').forEach(function(a){
        a.addEventListener('click', function(e){
          e.preventDefault();
          var key = a.dataset.key;
          var url = a.dataset.url;
          var newtab = a.dataset.newtab === 'true';
          pushRecent(key);

          if(newtab) window.open(url, '_blank', 'noopener,noreferrer');
          else window.location.href = url;
        });
      });

      // ì¦ê²¨ì°¾ê¸°
      content.querySelectorAll('[data-action="fav"]').forEach(function(s){
        s.addEventListener('click', function(){
          var key = s.dataset.key;
          toggleFavorite(key);
        });
      });

      // ì´ë¯¸ì§€(ì•„ì´ì½˜/íŒŒë¹„ì½˜) ì‹¤íŒ¨ í´ë°±: ğŸ”—
      content.querySelectorAll('img.favicon').forEach(function(img){
        img.addEventListener('error', function(){
          img.replaceWith(document.createTextNode('ğŸ”—'));
        }, { once:true });
      });
    }

    function modeTitle(){
      if(mode === 'FAV') return 'ì¦ê²¨ì°¾ê¸°';
      if(mode === 'RECENT') return 'ìµœê·¼';
      return 'ì „ì²´';
    }

    function filteredItems(){
      var items = (DATA.items || []).slice();

      if(mode === 'FAV'){
        var set = new Set(USER.favorites || []);
        items = items.filter(function(x){ return set.has(stableKey(x)); });
      }else if(mode === 'RECENT'){
        var order = USER.recents || [];
        var map = new Map(items.map(function(x){ return [stableKey(x), x]; }));
        items = order.map(function(k){ return map.get(k); }).filter(Boolean);
      }

      if(selectedCategory !== 'ALL'){
        items = items.filter(function(x){ return x.category === selectedCategory; });
      }

      if(query){
        var q = query.toLowerCase();
        items = items.filter(function(x){
          var hay = [x.name, x.desc, x.category, (x.tags || []).join(' ')].join(' ').toLowerCase();
          return hay.indexOf(q) !== -1;
        });
      }

      if(mode !== 'RECENT'){
        items.sort(function(a, b) {
          const as = Number(a.sort ?? 9999);
          const bs = Number(b.sort ?? 9999);
          if (as !== bs) return as - bs;
        
          const ac = String(a.category || '');
          const bc = String(b.category || '');
          if (ac !== bc) return ac.localeCompare(bc, 'ko');
        
          return String(a.name || '').localeCompare(String(b.name || ''), 'ko');
        });

        // items.sort(function(a,b){
        //   var ac = String(a.category || '');
        //   var bc = String(b.category || '');
        //   if(ac !== bc) return ac.localeCompare(bc, 'ko');
        //   var as = Number(a.sort || 9999);
        //   var bs = Number(b.sort || 9999);
        //   console.log(as, bs, a);
        //   if(as !== bs) return as - bs;
        //   return String(a.name || '').localeCompare(String(b.name || ''), 'ko');
        // });
      }

      return items;
    }

    // ===== favorites / recents =====
    function stableKey(item){
      return String(item.url || '') + '||' + String(item.name || '');
    }

    function toggleFavorite(key){
      var fav = new Set(USER.favorites || []);
      if(fav.has(key)) fav.delete(key); else fav.add(key);
      USER.favorites = Array.from(fav);
      persistUser();
      render();
    }

    function pushRecent(key){
      var arr = USER.recents || [];
      var next = [key].concat(arr.filter(function(x){ return x !== key; })).slice(0, 20);
      USER.recents = next;
      persistUser(false);
    }

    // var persistTimer = null;
    // function persistUser(reRender){
    //   if(reRender === undefined) reRender = true;
    //   clearTimeout(persistTimer);
    //   persistTimer = setTimeout(function(){
    //     saveUserState();
    //     if(reRender) render();
    //   }, 150);
    // }

    function isFav(item){
      var set = new Set(USER.favorites || []);
      return set.has(stableKey(item));
    }

    // ===== favicon fallback =====
    function getFaviconUrl(pageUrl){
      try{
        var u = new URL(pageUrl);
        return 'https://www.google.com/s2/favicons?domain=' + encodeURIComponent(u.hostname) + '&sz=64';
      }catch(e){
        return '';
      }
    }

    // ===== card UI =====
    function cardHtml(item){
      var key = stableKey(item);
      var favOn = isFav(item);

      // âœ… ìš°ì„ ìˆœìœ„: ì‹œíŠ¸ icon(=IMAGE("url")ì—ì„œ ì¶”ì¶œëœ URL) > íŒŒë¹„ì½˜ > (ì‹¤íŒ¨ ì‹œ ğŸ”—)
      var iconHtml;
      if(item.icon){
        iconHtml = '<img class="favicon" src="' + escapeAttr(item.icon) + '" alt="" loading="lazy">';
      }else{
        iconHtml = '<img class="favicon" src="' + escapeAttr(getFaviconUrl(item.url)) + '" alt="" loading="lazy">';
      }

      var tags = (item.tags || []).slice(0,4).map(function(t){
        return '<span class="tag">' + escapeHtml(t) + '</span>';
      }).join('');

      var pr = item.priority ? '<span class="tag priority">' + escapeHtml(item.priority) + '</span>' : '';

      return (
        '<div class="card">' +
          '<div class="row">' +
            '<div class="title">' +
              '<div class="icon">' + iconHtml + '</div>' +
              '<div>' +
                '<div>' + escapeHtml(item.name) + '</div>' +
                '<div class="muted" style="margin-top:2px;">' + escapeHtml(item.category) + '</div>' +
              '</div>' +
            '</div>' +
            '<div class="actions">' +
              '<div class="star ' + (favOn ? 'on' : '') + '" title="ì¦ê²¨ì°¾ê¸°" data-action="fav" data-key="' + escapeAttr(key) + '">' +
                (favOn ? 'â˜…' : 'â˜†') +
              '</div>' +
            '</div>' +
          '</div>' +

          '<div class="desc">' + escapeHtml(item.desc || 'ì„¤ëª… ì—†ìŒ') + '</div>' +

          '<div class="meta">' + pr + tags + '</div>' +

          '<div style="display:flex; gap:8px; align-items:center; margin-top:auto;">' +
            '<a class="btn" href="' + escapeAttr(item.url) + '"' +
              ' data-action="open"' +
              ' data-key="' + escapeAttr(key) + '"' +
              ' data-url="' + escapeAttr(item.url) + '"' +
              ' data-newtab="' + (item.newtab ? 'true' : 'false') + '">' +
              'ì—´ê¸°' +
            '</a>' +
            '<div class="muted url-text" title="' + escapeAttr(item.url) + '">' + escapeHtml(item.url) + '</div>' +
          '</div>' +
        '</div>'
      );
    }
  // ===== utils =====
    function escapeHtml(str){
      return String(str == null ? '' : str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }
    function escapeAttr(str){
      return escapeHtml(str).replaceAll('`','&#96;');
    }
    function cssEscape(str){
      return String(str == null ? '' : str).replaceAll('"','\\"');
    }
</script>
</body>
</html>
